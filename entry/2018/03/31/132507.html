<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-30867542-2"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-30867542-2', {
              page_path: window.location.pathname,
            });
          </script><meta charSet="utf-8"/><meta content="width=device-width, initial-scale=1, minimum-scale=1" name="viewport"/><link rel="icon" href="/images/notsobad/favicon.ico"/><meta name="description" content="ぼっちスタートアップが日々がんばっています。"/><meta content="website" property="og:type"/><meta content="NOT SO BADなブログ" property="og:site_name"/><meta content="summary_large_image" name="twitter:card"/><title>3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話</title><meta content="3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話" property="og:title"/><meta content="https://notsobad.jp/blog/2018/03/31/132507" property="og:url"/><link rel="canonical" href="https://blog.notsobad.jp/2018/03/31/132507"/><meta content="https://storage.googleapis.com/blog-notsobad/images/20180312145525.png" property="og:image"/><meta content="https://storage.googleapis.com/blog-notsobad/images/20180312145525.png" name="twitter:image:src"/><meta content="

Web上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。

&lt;iframe src=&quot;https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-tournament.jp%2F&quot; title=&quot;THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス&quot; class=&quot;embed-card embed-webcard&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; style=&quot;display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;&quot;&gt;&lt;/iframe&gt;&lt;cite class=&quot;hatena-citation&quot;&gt;&lt;a href=&quot;https://the-tournament.jp/&quot;&gt;the-tournament.jp&lt;/a&gt;&lt;/cite&gt;

最初に作ったのが2014年だったので、気づけばもう運営4年目。

ずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。

そんなお引っ越しの記録と振り返ってみての感想です。

（2018年8月追記）

Firebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。

[The Firebase Blog: More Cloud Firestore Improvements!](https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html)

（追記おわり）" property="og:description"/><meta content="3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話" name="twitter:title"/><meta content="

Web上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。

&lt;iframe src=&quot;https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-tournament.jp%2F&quot; title=&quot;THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス&quot; class=&quot;embed-card embed-webcard&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; style=&quot;display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;&quot;&gt;&lt;/iframe&gt;&lt;cite class=&quot;hatena-citation&quot;&gt;&lt;a href=&quot;https://the-tournament.jp/&quot;&gt;the-tournament.jp&lt;/a&gt;&lt;/cite&gt;

最初に作ったのが2014年だったので、気づけばもう運営4年目。

ずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。

そんなお引っ越しの記録と振り返ってみての感想です。

（2018年8月追記）

Firebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。

[The Firebase Blog: More Cloud Firestore Improvements!](https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html)

（追記おわり）" name="twitter:description"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/5644b8298dd7411e7ddf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5644b8298dd7411e7ddf.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-277c75ec70a3d22a400d.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework-6b728500358bd9f227e4.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-38482bdb4ba8803cee02.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-de79de6c1e2dcb6d52dc.js" as="script"/><link rel="preload" href="/_next/static/chunks/23-a289b06b4258f5c2d579.js" as="script"/><link rel="preload" href="/_next/static/chunks/996-fa0b52be06882e958afa.js" as="script"/><link rel="preload" href="/_next/static/chunks/724-975cef7c19a6db045a02.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/entry/%5B...slug%5D-3127ec1dc84fe9f11e8f.js" as="script"/></head><body><div id="__next"><div><section class="text-gray-700 body-font"><div class="container px-5 md:px-24 p-5 md:pb-12 mx-auto max-w-screen-lg"><h1 class="text-xl font-bold title-font text-gray-900 mb-4 inline-block border-b-4 border-gray-900"><a href="/">NOT SO BAD なブログ</a></h1><h2 class="text-xs text-gray-700 tracking-widest font-medium title-font">ぼっちスタートアップが日々がんばっています。</h2></div></section><section class="text-gray-700 body-font overflow-hidden break-all"><div class="container px-5 md:px-24 pb-24 mx-auto max-w-screen-lg"><div class="-my-8"><div class="py-12 flex flex-wrap md:flex-no-wrap"><div class="md:w-64 md:mb-0 mb-6 flex-shrink-0 flex flex-col"><span class="mt-1 text-gray-900 font-bold">2018-03-31</span></div><div class="flex-grow"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 title-font mb-4">3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話</h2><div class="mb-4"><a href="/tag/%E6%8A%80%E8%A1%93%E7%B3%BB"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">技術系</span></a><a href="/tag/THE%20TOURNAMENT"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">THE TOURNAMENT</span></a><a href="/tag/Firebase"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">Firebase</span></a><a href="/tag/Heroku"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">Heroku</span></a><a href="/tag/Riot.js"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">Riot.js</span></a></div><img src="https://storage.googleapis.com/blog-notsobad/images/20180312145525.png" alt="3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話" class="mb-4"/><div id="mainText" class="leading-relaxed"><p class="mt-4 mb-8">Web上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。</p><span><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-tournament.jp%2F" title="THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://the-tournament.jp/">the-tournament.jp</a></cite></span><p class="mt-4 mb-8">最初に作ったのが2014年だったので、気づけばもう運営4年目。</p><p class="mt-4 mb-8">ずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。</p><p class="mt-4 mb-8">そんなお引っ越しの記録と振り返ってみての感想です。</p><p class="mt-4 mb-8">（2018年8月追記）</p><p class="mt-4 mb-8">Firebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。</p><p class="mt-4 mb-8"><a href="https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html" target="_blank" class="text-blue-600 underline">The Firebase Blog: More Cloud Firestore Improvements!</a></p><p class="mt-4 mb-8">（追記おわり）* * *</p><h2 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-2xl">🤔なんで移行したの？</h2><p class="mt-4 mb-8">大前提として、HerokuとRailsは今でも大好きですw</p><p class="mt-4 mb-8">じゃあなんで移行したんだよって話ですが、理由は大きく以下の２つでした。</p><ul class="text-left list-disc ml-6"><li class="leading-8">Herokuを無料で使い続ける限界が近づいていた</li><li class="leading-8">トーナメント作成をjsベースでインタラクティブにしたかった</li></ul><p class="mt-4 mb-8">前にこんなLTもしましたが、トーナメントは相当アクセスが増えても無料でしのげる仕組みにはしていました。</p><span><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.notsobad.jp%2Fentry%2F2018%2F02%2F04%2F170844" title="Herokuの無料プランで月間100万PVをさばく（さばかない）話 - NOT SO BADなブログ" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://blog.notsobad.jp/entry/2018/02/04/170844">blog.notsobad.jp</a></cite></span><p class="mt-4 mb-8">とはいえおかげさまで作成側の負荷も増えてきていたのと、DBも無料だと1万レコード制限があって、そろそろこれも限界が近づいていました。</p><p class="mt-4 mb-8">また、リニューアルの大きな目的の1つが、jsでインタラクティブにトーナメント表を編集できるようにすることでした。</p><p class="mt-4 mb-8"><img alt="f:id:o_tomomichi:20180331115841p:plain" title="f:id:o_tomomichi:20180331115841p:plain" src="https://storage.googleapis.com/blog-notsobad/images/20180331115841.png"/></p><p class="mt-4 mb-8">Webpackerでjsフレームワークの導入に挑戦するという選択肢もあったのですが、まぁ率直に「これRailsじゃなくてよくね？」と気づいてしまったのは否定できません。</p><p class="mt-4 mb-8">というか、こういうフロント中心のサービスでバックエンドも楽したいって思ったときに、Firebaseがどんぴしゃすぎるんですよね。。 <a href="https://the-timeline.jp/" target="_blank" class="text-blue-600 underline">別のプロダクト</a>で1年くらいFirebaseを運用していたこともあり、もうこれでいいんじゃないのーと思えたのも移行のきっかけです。</p><p class="mt-4 mb-8">1年前の時点でフロントエンドのフレームワークはまったく経験がなかったので、一番シンプルで学習コストが低そうなRiot.jsをチョイスしてました。いまならVue.jsにしてたかもですが、Riot.jsもこれくらいの規模なら全然問題なく、シンプルでよい感じです。</p><hr class="my-8"/><h2 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-2xl">😇 移行してみてのうれしみ</h2><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">無料枠が大きすぎ</h3><p class="mt-4 mb-8">FirestoreもHostingもFunctionsも、いまのところ無料枠で収まりそうです。うれしい。</p><p class="mt-4 mb-8">しかもつい先日、従量課金型のBlazeプランにも無料のSparkプランとほぼ同じ無料枠が割り当てられるようになりました。 （いままではBlazeを選択したら最初の1バイトから課金対象になってた）</p><span><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Ffirebase.googleblog.com%2F2018%2F03%2Fadding-free-usage-to-blaze-pricing-plan.html" title="Adding free usage to Blaze pricing plan" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://firebase.googleblog.com/2018/03/adding-free-usage-to-blaze-pricing-plan.html">firebase.googleblog.com</a></cite></span><p class="mt-4 mb-8">これなら基本無料で運用できて、急なアクセス増のときだけ従量課金でさばいてくれるので、かなりよさそうです。</p><p class="mt-4 mb-8">ただBlazeは上限設定ができないのが怖くてまだ移行してないけど。。</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">ユーザー認証が簡単すぎ</h3><p class="mt-4 mb-8">FirebaseのAuthenticationは、めちゃくちゃよくできています。</p><p class="mt-4 mb-8">デフォルトで主要SNSログインの仕組みも用意してくれてるので、各SNS側でアプリだけ作って指示通り設定すれば、すぐにログインの仕組みができてしまいました。</p><p class="mt-4 mb-8"><img alt="f:id:o_tomomichi:20180312141940p:plain" title="f:id:o_tomomichi:20180312141940p:plain" src="https://storage.googleapis.com/blog-notsobad/images/20180312141940.png"/></p><p class="mt-4 mb-8">さらに最近のアップデートでパスワード不要のメールログインの仕組みが公式に実装されました。神！</p><p class="mt-4 mb-8"><a href="https://firebase.google.com/docs/auth/web/email-link-auth" target="_blank" class="text-blue-600 underline">Authenticate with Firebase Using Email Link in JavaScript  |  Firebase</a></p><p class="mt-4 mb-8">自前で同じ仕組みを実装してたので、早く乗り換えねば。</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">Functionsが便利すぎ</h3><p class="mt-4 mb-8">これはほんとに便利。</p><p class="mt-4 mb-8">うちではデータの更新を検知して、なんちゃってSSRみたいなことをして静的HTMLを出力するという処理を走らせています。</p><p class="mt-4 mb-8"><img alt="f:id:o_tomomichi:20180312142426p:plain" title="f:id:o_tomomichi:20180312142426p:plain" src="https://storage.googleapis.com/blog-notsobad/images/20180312142426.png"/></p><p class="mt-4 mb-8">いままではHerokuのSchedulerアドオンでバッチ処理を走らせて同じことをしていました。 ただこれがFree Dynoのメモリを圧迫していて、処理が安定しなくなっていた原因でもありました。</p><p class="mt-4 mb-8">Functionsは無料プランでも結構なキャパがあるので、頼もしいです。すごい。</p><hr class="my-8"/><h2 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-2xl">💩 移行してみてのつらみ</h2><p class="mt-4 mb-8">一方でFirebaseに移行して感じているつらみと不安。</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">カジュアルに障害が起きる</h3><p class="mt-4 mb-8">ベータのサービスが多いせいもありますが、よく落ちます。</p><p class="mt-4 mb-8">自分が使っている範囲だと特にHostingとFunctionsがやばい。カジュアルに落ちます。</p><p class="mt-4 mb-8">インフラ側で落ちちゃうとどうしようもなくて結構困ってしまうのですが、DB（Firestore）が無事でHostingが落ちてるだけなら、最悪Storageにでも置きなおしてドメイン振ればいけるはず。</p><p class="mt-4 mb-8">一方でFirestoreが落ちると、けっこうどうしようもないですね。どうしよう。 今のところFirestoreはほぼ障害ないのが救いですが。。（レスポンスがめっちゃ遅くなるときはある）</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">管理画面が貧弱</h3><p class="mt-4 mb-8">サービスを運営していると、データをちょっと修正したいときとかあるじゃないですか。 Firebaseの公式管理画面（コンソール）だと、これがものすごく大変です。 データの一覧性もないし、検索性はほぼないし、クエリ投げたりもできないし。。</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">データバックアップができない</h3><p class="mt-4 mb-8">できません。どうしたらいいんですか（切実）。</p><p class="mt-4 mb-8">RealtimeDatabaseは有料プランならバックアップオプションが用意されてたんですが、Firestoreは有料版でもそもそも存在しない。。 一応npmモジュールでバックアップ取れるやつがあるので触ってみてますが、もうちょっと公式でサポートしてほしい。</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">初回表示が遅くなった</h3><p class="mt-4 mb-8">これはfirebaseの問題ではなく、SPA化したことの弊害ですね。 何も考えずにSPA化すると、最初の読み込みが重くなりがち。一回読み込めば中の遷移はさくさくなんですけどね。</p><p class="mt-4 mb-8">キャッシュがない状態でもユーザービリティを損なうほど遅いわけじゃないので、いったん後回しにしてます。 ただPageSpeedInsightとか Lighthouseとかでauditしてみると、めっちゃ怒られる。。</p><p class="mt-4 mb-8">トップページから入ってきて中に進むユーザーが多いので、将来的にはトップページを静的にしてAMP化、後続のアプリ部分をPWA化しておいて、AMPアクセス時にpreloadするような仕組み（PWAMP！）にすれば爆速化できるんじゃないかと思ってます。が、PWAこわくてまだ手を出せてない。</p><span><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.ampproject.org%2Fdocs%2Fintegration%2Fpwa-amp%23amp-as-entry-point-into-your-pwa" title="Combine AMP with Progressive Web Apps – AMP" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://www.ampproject.org/docs/integration/pwa-amp#amp-as-entry-point-into-your-pwa">www.ampproject.org</a></cite></span><p class="mt-4 mb-8">MobileFirstIndexも始まったし、そろそろやらねばですね。がんばる。。</p><h3 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-xl">SEOも弱くなった</h3><p class="mt-4 mb-8">これもFirebaseは関係なく、よく言われるSPA化の弊害に見事にはまってしまいました。</p><ul class="text-left list-disc ml-6"><li class="leading-8">Googleにインデックスされず、SEOに弱くなった</li><li class="leading-8">SNSシェア時にOGPが反映されない</li></ul><p class="mt-4 mb-8">どちらもbotがアクセスしてきたときに、動的に変更してるmetaタグを読めず、エンドポイントのindex.htmlに書いてあるデフォルトのmetaタグを読んじゃってることが原因です。</p><p class="mt-4 mb-8">これについては、特にSEO/OGPが必要になるコンテンツページに絞って、Functionsで動的にmetaタグを書き換えて配信することで一応対応できました。</p><p class="mt-4 mb-8">またbotがページ内のリンクたどれてるかもあやしいので、sitemapとRSSフィードを配信してクロールしやすくもしています。</p><p class="mt-4 mb-8">この辺の詳細はまた別で整理してみようかと。</p><p class="mt-4 mb-8">（2018年4月3日追記）</p><span><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.notsobad.jp%2Fentry%2F2018%2F04%2F03%2F235004" title="Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話 - NOT SO BADなブログ" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://blog.notsobad.jp/entry/2018/04/03/235004">blog.notsobad.jp</a></cite></span><p class="mt-4 mb-8">書きました。</p><hr class="my-8"/><h2 class="font-bold inline-block mb-2 mt-8 md:mt-8 text-2xl">まとめ</h2><p class="mt-4 mb-8">なぜかうれしみよりつらみの方が多くなってしまった。なぜだ。。 しかし実際にリニューアルは不可避でしたし、いまのところ非常にうまく機能してると思います。</p><p class="mt-4 mb-8">またぼくが解決策を知らないだけの可能性もあるので、もしお気づきのところあれば指摘もらえるとうれしいです。 ベータ版を抜ければ解決しそうな問題も多いので、早く公式で色々対応してくれるといいですね。</p><p class="mt-4 mb-8">信じてもらえないかもしれないけど、Firebaseは本当におすすめですよ。 みんな早くおいで！</p><p class="mt-4 mb-8">おしまい。</p></div></div></div></div></div></section><footer class="text-gray-200 body-font"><div class="bg-gray-900"><div class="container mx-auto py-6 px-5 md:px-24 flex flex-wrap flex-col sm:flex-row max-w-screen-lg"><p class="text-gray-200 text-sm text-center sm:text-left"><a class="text-gray-500 hover:text-gray-200 ml-1" href="/">© 2020 NOT SO BADなブログ</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"title":"3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話","slug":"2018/03/31/132507","excerpt":"![f:id:o_tomomichi:20180312145525p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312145525.png \"f:id:o_tomomichi:20180312145525p:plain\")\n\nWeb上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-tournament.jp%2F\" title=\"THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://the-tournament.jp/\"\u003ethe-tournament.jp\u003c/a\u003e\u003c/cite\u003e\n\n最初に作ったのが2014年だったので、気づけばもう運営4年目。\n\nずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。\n\nそんなお引っ越しの記録と振り返ってみての感想です。\n\n（2018年8月追記）\n\nFirebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。\n\n[The Firebase Blog: More Cloud Firestore Improvements!](https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html)\n\n（追記おわり）","content":"![f:id:o_tomomichi:20180312145525p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312145525.png \"f:id:o_tomomichi:20180312145525p:plain\")\n\nWeb上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-tournament.jp%2F\" title=\"THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://the-tournament.jp/\"\u003ethe-tournament.jp\u003c/a\u003e\u003c/cite\u003e\n\n最初に作ったのが2014年だったので、気づけばもう運営4年目。\n\nずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。\n\nそんなお引っ越しの記録と振り返ってみての感想です。\n\n（2018年8月追記）\n\nFirebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。\n\n[The Firebase Blog: More Cloud Firestore Improvements!](https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html)\n\n（追記おわり）* * *\n\n🤔なんで移行したの？\n-----------\n\n大前提として、HerokuとRailsは今でも大好きですw\n\nじゃあなんで移行したんだよって話ですが、理由は大きく以下の２つでした。\n\n*   Herokuを無料で使い続ける限界が近づいていた\n*   トーナメント作成をjsベースでインタラクティブにしたかった\n\n前にこんなLTもしましたが、トーナメントは相当アクセスが増えても無料でしのげる仕組みにはしていました。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.notsobad.jp%2Fentry%2F2018%2F02%2F04%2F170844\" title=\"Herokuの無料プランで月間100万PVをさばく（さばかない）話 - NOT SO BADなブログ\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://blog.notsobad.jp/entry/2018/02/04/170844\"\u003eblog.notsobad.jp\u003c/a\u003e\u003c/cite\u003e\n\nとはいえおかげさまで作成側の負荷も増えてきていたのと、DBも無料だと1万レコード制限があって、そろそろこれも限界が近づいていました。\n\nまた、リニューアルの大きな目的の1つが、jsでインタラクティブにトーナメント表を編集できるようにすることでした。\n\n![f:id:o_tomomichi:20180331115841p:plain](https://storage.googleapis.com/blog-notsobad/images/20180331115841.png \"f:id:o_tomomichi:20180331115841p:plain\")\n\nWebpackerでjsフレームワークの導入に挑戦するという選択肢もあったのですが、まぁ率直に「これRailsじゃなくてよくね？」と気づいてしまったのは否定できません。\n\nというか、こういうフロント中心のサービスでバックエンドも楽したいって思ったときに、Firebaseがどんぴしゃすぎるんですよね。。 [別のプロダクト](https://the-timeline.jp/)で1年くらいFirebaseを運用していたこともあり、もうこれでいいんじゃないのーと思えたのも移行のきっかけです。\n\n1年前の時点でフロントエンドのフレームワークはまったく経験がなかったので、一番シンプルで学習コストが低そうなRiot.jsをチョイスしてました。いまならVue.jsにしてたかもですが、Riot.jsもこれくらいの規模なら全然問題なく、シンプルでよい感じです。\n\n* * *\n\n😇 移行してみてのうれしみ\n--------------\n\n### 無料枠が大きすぎ\n\nFirestoreもHostingもFunctionsも、いまのところ無料枠で収まりそうです。うれしい。\n\nしかもつい先日、従量課金型のBlazeプランにも無料のSparkプランとほぼ同じ無料枠が割り当てられるようになりました。 （いままではBlazeを選択したら最初の1バイトから課金対象になってた）\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Ffirebase.googleblog.com%2F2018%2F03%2Fadding-free-usage-to-blaze-pricing-plan.html\" title=\"Adding free usage to Blaze pricing plan\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://firebase.googleblog.com/2018/03/adding-free-usage-to-blaze-pricing-plan.html\"\u003efirebase.googleblog.com\u003c/a\u003e\u003c/cite\u003e\n\nこれなら基本無料で運用できて、急なアクセス増のときだけ従量課金でさばいてくれるので、かなりよさそうです。\n\nただBlazeは上限設定ができないのが怖くてまだ移行してないけど。。\n\n### ユーザー認証が簡単すぎ\n\nFirebaseのAuthenticationは、めちゃくちゃよくできています。\n\nデフォルトで主要SNSログインの仕組みも用意してくれてるので、各SNS側でアプリだけ作って指示通り設定すれば、すぐにログインの仕組みができてしまいました。\n\n![f:id:o_tomomichi:20180312141940p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312141940.png \"f:id:o_tomomichi:20180312141940p:plain\")\n\nさらに最近のアップデートでパスワード不要のメールログインの仕組みが公式に実装されました。神！\n\n[Authenticate with Firebase Using Email Link in JavaScript  |  Firebase](https://firebase.google.com/docs/auth/web/email-link-auth)\n\n自前で同じ仕組みを実装してたので、早く乗り換えねば。\n\n### Functionsが便利すぎ\n\nこれはほんとに便利。\n\nうちではデータの更新を検知して、なんちゃってSSRみたいなことをして静的HTMLを出力するという処理を走らせています。\n\n![f:id:o_tomomichi:20180312142426p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312142426.png \"f:id:o_tomomichi:20180312142426p:plain\")\n\nいままではHerokuのSchedulerアドオンでバッチ処理を走らせて同じことをしていました。 ただこれがFree Dynoのメモリを圧迫していて、処理が安定しなくなっていた原因でもありました。\n\nFunctionsは無料プランでも結構なキャパがあるので、頼もしいです。すごい。\n\n* * *\n\n💩 移行してみてのつらみ\n-------------\n\n一方でFirebaseに移行して感じているつらみと不安。\n\n### カジュアルに障害が起きる\n\nベータのサービスが多いせいもありますが、よく落ちます。\n\n自分が使っている範囲だと特にHostingとFunctionsがやばい。カジュアルに落ちます。\n\nインフラ側で落ちちゃうとどうしようもなくて結構困ってしまうのですが、DB（Firestore）が無事でHostingが落ちてるだけなら、最悪Storageにでも置きなおしてドメイン振ればいけるはず。\n\n一方でFirestoreが落ちると、けっこうどうしようもないですね。どうしよう。 今のところFirestoreはほぼ障害ないのが救いですが。。（レスポンスがめっちゃ遅くなるときはある）\n\n### 管理画面が貧弱\n\nサービスを運営していると、データをちょっと修正したいときとかあるじゃないですか。 Firebaseの公式管理画面（コンソール）だと、これがものすごく大変です。 データの一覧性もないし、検索性はほぼないし、クエリ投げたりもできないし。。\n\n### データバックアップができない\n\nできません。どうしたらいいんですか（切実）。\n\nRealtimeDatabaseは有料プランならバックアップオプションが用意されてたんですが、Firestoreは有料版でもそもそも存在しない。。 一応npmモジュールでバックアップ取れるやつがあるので触ってみてますが、もうちょっと公式でサポートしてほしい。\n\n### 初回表示が遅くなった\n\nこれはfirebaseの問題ではなく、SPA化したことの弊害ですね。 何も考えずにSPA化すると、最初の読み込みが重くなりがち。一回読み込めば中の遷移はさくさくなんですけどね。\n\nキャッシュがない状態でもユーザービリティを損なうほど遅いわけじゃないので、いったん後回しにしてます。 ただPageSpeedInsightとか Lighthouseとかでauditしてみると、めっちゃ怒られる。。\n\nトップページから入ってきて中に進むユーザーが多いので、将来的にはトップページを静的にしてAMP化、後続のアプリ部分をPWA化しておいて、AMPアクセス時にpreloadするような仕組み（PWAMP！）にすれば爆速化できるんじゃないかと思ってます。が、PWAこわくてまだ手を出せてない。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.ampproject.org%2Fdocs%2Fintegration%2Fpwa-amp%23amp-as-entry-point-into-your-pwa\" title=\"Combine AMP with Progressive Web Apps – AMP\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://www.ampproject.org/docs/integration/pwa-amp#amp-as-entry-point-into-your-pwa\"\u003ewww.ampproject.org\u003c/a\u003e\u003c/cite\u003e\n\nMobileFirstIndexも始まったし、そろそろやらねばですね。がんばる。。\n\n### SEOも弱くなった\n\nこれもFirebaseは関係なく、よく言われるSPA化の弊害に見事にはまってしまいました。\n\n*   Googleにインデックスされず、SEOに弱くなった\n*   SNSシェア時にOGPが反映されない\n\nどちらもbotがアクセスしてきたときに、動的に変更してるmetaタグを読めず、エンドポイントのindex.htmlに書いてあるデフォルトのmetaタグを読んじゃってることが原因です。\n\nこれについては、特にSEO/OGPが必要になるコンテンツページに絞って、Functionsで動的にmetaタグを書き換えて配信することで一応対応できました。\n\nまたbotがページ内のリンクたどれてるかもあやしいので、sitemapとRSSフィードを配信してクロールしやすくもしています。\n\nこの辺の詳細はまた別で整理してみようかと。\n\n（2018年4月3日追記）\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.notsobad.jp%2Fentry%2F2018%2F04%2F03%2F235004\" title=\"Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話 - NOT SO BADなブログ\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://blog.notsobad.jp/entry/2018/04/03/235004\"\u003eblog.notsobad.jp\u003c/a\u003e\u003c/cite\u003e\n\n書きました。\n\n* * *\n\nまとめ\n---\n\nなぜかうれしみよりつらみの方が多くなってしまった。なぜだ。。 しかし実際にリニューアルは不可避でしたし、いまのところ非常にうまく機能してると思います。\n\nまたぼくが解決策を知らないだけの可能性もあるので、もしお気づきのところあれば指摘もらえるとうれしいです。 ベータ版を抜ければ解決しそうな問題も多いので、早く公式で色々対応してくれるといいですね。\n\n信じてもらえないかもしれないけど、Firebaseは本当におすすめですよ。 みんな早くおいで！\n\nおしまい。","date":1522470307000,"image":"https://storage.googleapis.com/blog-notsobad/images/20180312145525.png","tag":["技術系","THE TOURNAMENT","Firebase","Heroku","Riot.js"]}},"__N_SSG":true},"page":"/entry/[...slug]","query":{"slug":["2018","03","31","132507"]},"buildId":"K3YMmB9NhNXs2s9mTrvrO","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-eef578260fd80f8fff94.js"></script><script src="/_next/static/chunks/webpack-277c75ec70a3d22a400d.js" async=""></script><script src="/_next/static/chunks/framework-6b728500358bd9f227e4.js" async=""></script><script src="/_next/static/chunks/main-38482bdb4ba8803cee02.js" async=""></script><script src="/_next/static/chunks/pages/_app-de79de6c1e2dcb6d52dc.js" async=""></script><script src="/_next/static/chunks/23-a289b06b4258f5c2d579.js" async=""></script><script src="/_next/static/chunks/996-fa0b52be06882e958afa.js" async=""></script><script src="/_next/static/chunks/724-975cef7c19a6db045a02.js" async=""></script><script src="/_next/static/chunks/pages/entry/%5B...slug%5D-3127ec1dc84fe9f11e8f.js" async=""></script><script src="/_next/static/K3YMmB9NhNXs2s9mTrvrO/_buildManifest.js" async=""></script><script src="/_next/static/K3YMmB9NhNXs2s9mTrvrO/_ssgManifest.js" async=""></script></body></html>