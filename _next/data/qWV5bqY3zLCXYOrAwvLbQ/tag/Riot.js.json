{"pageProps":{"entries":{"items":[{"sys":{"space":{"sys":{"type":"Link","linkType":"Space","id":"2widkdbc59vz"}},"id":"60BpGYN2APP9nXbVSCmS6m","type":"Entry","createdAt":"2020-05-27T09:06:45.385Z","updatedAt":"2020-06-03T09:47:13.060Z","environment":{"sys":{"id":"master","type":"Link","linkType":"Environment"}},"revision":3,"contentType":{"sys":{"type":"Link","linkType":"ContentType","id":"post"}},"locale":"en-US"},"fields":{"title":"Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話","slug":"2018/04/03/235004","excerpt":"FJUG#3でLTさせてもらってきました！\n\n[firebase-community.connpass.com](https://firebase-community.connpass.com/event/80526/)\n\n前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。\n\n発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。","content":"FJUG#3でLTさせてもらってきました！\n\n[firebase-community.connpass.com](https://firebase-community.connpass.com/event/80526/)\n\n前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。\n\n発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。* * *\n\nLT内容\n----\n\n[https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban](https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban)\n\n3行で要約\n-----\n\n*   Riot.js/Firebaseでサービスをリニューアルしたら、Googleにインデックスされなくなって困りました\n*   SSRとか大変なのは避けたかったので、Functionsでmetaタグだけ差し替えたんだけどいいですよね？\n*   それだけだとクロールされないので、Functionsで超お手軽にRSSフィードとsitemapを配信する方法も試してみましたよ。\n\n一言でいうと、Functions最高ー。\n\n背景的な話\n-----\n\nこのコンテンツは、こちらの記事の追記のような位置付けです。\n\n[blog.notsobad.jp](http://blog.notsobad.jp/entry/2018/03/31/132507)\n\nサイトリニューアルで出てきたSEO問題を、できるだけ楽して解決できないかとがんばった記録になっております。\n\nエクスキューズ\n-------\n\nこれでいいんじゃないですかとか適当なこと言ってますが、会社でこんなことしてたら怒られるかもしれないので気をつけてください。\n\n> 「SSRまではいらないけど、ある程度metaを動的にコントロールしたい」っていう欲求は結構理解できる。特に趣味プロでバックにfirebase 、みたいなシチュと割と相性良さそうなイメージだ [#fjug](https://twitter.com/hashtag/fjug?src=hash&ref_src=twsrc%5Etfw)\n> \n> — Yosuke Kurami (@Quramy) [2018年4月2日](https://twitter.com/Quramy/status/980772868182065152?ref_src=twsrc%5Etfw)\n\n温度感としては、@Quramyさんが書いてくださってるのがほんとにその通りって感じじゃないかと。\n\nスライドにも書いてますが、とはいえGoogleBotにちゃんと認識されてるならそもそもこんなことしたくなかったわけで。。\n\nあくまでインデックスされなくて困ってて、でもSSRまでしたくなくて、っていうひとつの事例としてお楽しみください。 （パフォーマンス改善のためにSSR、とかって文脈ではない）\n\n同じようなシチュエーションの人の助けになればうれしいです。\n\n* * *\n\n以下、やったこと３つをそれぞれ少しだけ追加説明していきます。\n\n① Functionsでmetaタグだけレンダリング\n--------------------------\n\n要するに、SPAでエンドポイントになるindex.htmlをそのまま返すんじゃなくて、functionsをかませてmetaタグだけ書き換えてから返すという、SMR（Serverside Metatag Rendering）です。聞いたことないけど。\n\nけっこう探しても事例がなくて不安だったんですが、Lambdaでやってるという話を聞くと安心感があります。\n\n> 同じようなコンテキストでAWS Lambdaで動的にmetaレンダリングしてます、みたいな話を以前に聞いたことあるし、function 利用してmetaもそんなに悪手では無い気と思ってる [#fjug](https://twitter.com/hashtag/fjug?src=hash&ref_src=twsrc%5Etfw)\n> \n> — Yosuke Kurami (@Quramy) [2018年4月2日](https://twitter.com/Quramy/status/980772075513176064?ref_src=twsrc%5Etfw)\n\n全体的に@Quramyさんのコメントに救われてる。。\n\nこのやり方で懸念になるのはFunctionsの使用量とパフォーマンスなわけですが、FunctionsのレスポンスはCDNにキャッシュできるというのが、意外と知られていなかったりしますよね（ぼくが知らなかっただけですがw）\n\n[Cloud Functions による動的コンテンツの配信  |  Firebase](https://firebase.google.com/docs/hosting/functions?hl=ja#managing_cache_behavior)\n\nCDNから返してくれればFunctionsはトリガーされずに済むので、アクセスが増えてもそこまで使用量は増えない、はず。\n\nとはいえまだ実運用で大量のアクセスさばいて大丈夫でした、という経験があるわけではないので、ご利用は自己責任でお願いします。 blazeプランは料金上限を設定できないって、結構こわいですね。\n\n* * *\n\n② Functionsでお手軽RSSフィード配信\n------------------------\n\nmetaタグレンダリングでbotに認識されるようになりましたが、クロールしてもらえないと意味がありません。 というわけでRSSフィードとsitemapを極小労力で用意してみます。\n\nまずはRSSフィードですが、これもFunctionsを使って、/feedにアクセスが来たらfirestoreから最新のデータを取ってXMLで返すようにしました。\n\n簡単すぎて、node-rssが便利だったことくらいしか特に言うことがない。。\n\nしかし猛烈にお手軽なので、とりあえずやっといて損はないんじゃないでしょうか。 これこそ更新は1日数回でいいと思うので、長めにキャッシュして節約したいところです。\n\n* * *\n\n③ スプレッドシートでお手軽sitemap配信\n-----------------------\n\n最後にsitemapの作成。たぶん過去最高に頭わるそうなsitemapのハックです。\n\n![f:id:o_tomomichi:20180403184508p:plain](https://storage.googleapis.com/blog-notsobad/images/20180403184508.png \"f:id:o_tomomichi:20180403184508p:plain\")\n\nということは、スプレッドシートにURL一覧作ってCSV形式で公開すると、それがvalidなsitemapのURLになってしまうと。\n\nさらに更新は、さっきのRSSのフィード更新をトリガーに、IFTTTでシートに自動追記。 ついにコードを1行も書くことすらなく、自動更新されるsitemapをお手軽に作ることができました。\n\nsitemapの管理って地味にめんどくさいので、ミニマムでやるなら意外とおすすめです。 機会があればぜひ試してみてください。\n\n* * *\n\nまとめ\n---\n\nという感じでLTをしてきたのですが、調べて実装終えたのが発表ぎりぎりだったので、結果の検証までできてませんでした。\n\n実装から数日経ってどうなったかというと、、\n\n![f:id:o_tomomichi:20180403185752p:plain](https://storage.googleapis.com/blog-notsobad/images/20180403185752.png \"f:id:o_tomomichi:20180403185752p:plain\")\n\n![f:id:o_tomomichi:20180403185803p:plain](https://storage.googleapis.com/blog-notsobad/images/20180403185803.png \"f:id:o_tomomichi:20180403185803p:plain\")\n\nいい感じ。\n\nもちろんfunctionsも無料枠で収まるペースです。よかったよかった。","date":1522767004000,"image":"https://storage.googleapis.com/blog-notsobad/images/20180403035841.png","tag":["技術系","Firebase","THE TOURNAMENT","Riot.js"]}},{"sys":{"space":{"sys":{"type":"Link","linkType":"Space","id":"2widkdbc59vz"}},"id":"5if6MqMHq4i7gglLyZ6qpK","type":"Entry","createdAt":"2020-05-27T09:06:47.317Z","updatedAt":"2020-06-03T09:47:16.351Z","environment":{"sys":{"id":"master","type":"Link","linkType":"Environment"}},"revision":3,"contentType":{"sys":{"type":"Link","linkType":"ContentType","id":"post"}},"locale":"en-US"},"fields":{"title":"3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話","slug":"2018/03/31/132507","excerpt":"![f:id:o_tomomichi:20180312145525p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312145525.png \"f:id:o_tomomichi:20180312145525p:plain\")\n\nWeb上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。\n\n[the-tournament.jp](https://the-tournament.jp/)\n\n最初に作ったのが2014年だったので、気づけばもう運営4年目。\n\nずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。\n\nそんなお引っ越しの記録と振り返ってみての感想です。\n\n（2018年8月追記）\n\nFirebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。\n\n[The Firebase Blog: More Cloud Firestore Improvements!](https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html)\n\n（追記おわり）","content":"![f:id:o_tomomichi:20180312145525p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312145525.png \"f:id:o_tomomichi:20180312145525p:plain\")\n\nWeb上で簡単にきれいなトーナメント表が作れる、「THE TOURNAMENT」という超絶地味なサービスを運営しています。\n\n[the-tournament.jp](https://the-tournament.jp/)\n\n最初に作ったのが2014年だったので、気づけばもう運営4年目。\n\nずっと「Rails×Heroku」で運用してきたのですが、ちょうど先日サービスを全面リニューアルして、「Riot.js×Firebase」に移行しました。\n\nそんなお引っ越しの記録と振り返ってみての感想です。\n\n（2018年8月追記）\n\nFirebaseは恐ろしい勢いで改善し続けているので、この記事に書いてあるつらみもどんどん解消されつつあります。 ますますおすすめなのでぜひ使ってみてください。\n\n[The Firebase Blog: More Cloud Firestore Improvements!](https://firebase.googleblog.com/2018/08/more-cloud-firestore-improvements.html)\n\n（追記おわり）* * *\n\n🤔なんで移行したの？\n-----------\n\n大前提として、HerokuとRailsは今でも大好きですw\n\nじゃあなんで移行したんだよって話ですが、理由は大きく以下の２つでした。\n\n*   Herokuを無料で使い続ける限界が近づいていた\n*   トーナメント作成をjsベースでインタラクティブにしたかった\n\n前にこんなLTもしましたが、トーナメントは相当アクセスが増えても無料でしのげる仕組みにはしていました。\n\n[blog.notsobad.jp](http://blog.notsobad.jp/entry/2018/02/04/170844)\n\nとはいえおかげさまで作成側の負荷も増えてきていたのと、DBも無料だと1万レコード制限があって、そろそろこれも限界が近づいていました。\n\nまた、リニューアルの大きな目的の1つが、jsでインタラクティブにトーナメント表を編集できるようにすることでした。\n\n![f:id:o_tomomichi:20180331115841p:plain](https://storage.googleapis.com/blog-notsobad/images/20180331115841.png \"f:id:o_tomomichi:20180331115841p:plain\")\n\nWebpackerでjsフレームワークの導入に挑戦するという選択肢もあったのですが、まぁ率直に「これRailsじゃなくてよくね？」と気づいてしまったのは否定できません。\n\nというか、こういうフロント中心のサービスでバックエンドも楽したいって思ったときに、Firebaseがどんぴしゃすぎるんですよね。。 [別のプロダクト](https://the-timeline.jp/)で1年くらいFirebaseを運用していたこともあり、もうこれでいいんじゃないのーと思えたのも移行のきっかけです。\n\n1年前の時点でフロントエンドのフレームワークはまったく経験がなかったので、一番シンプルで学習コストが低そうなRiot.jsをチョイスしてました。いまならVue.jsにしてたかもですが、Riot.jsもこれくらいの規模なら全然問題なく、シンプルでよい感じです。\n\n* * *\n\n😇 移行してみてのうれしみ\n--------------\n\n### 無料枠が大きすぎ\n\nFirestoreもHostingもFunctionsも、いまのところ無料枠で収まりそうです。うれしい。\n\nしかもつい先日、従量課金型のBlazeプランにも無料のSparkプランとほぼ同じ無料枠が割り当てられるようになりました。 （いままではBlazeを選択したら最初の1バイトから課金対象になってた）\n\n[firebase.googleblog.com](https://firebase.googleblog.com/2018/03/adding-free-usage-to-blaze-pricing-plan.html)\n\nこれなら基本無料で運用できて、急なアクセス増のときだけ従量課金でさばいてくれるので、かなりよさそうです。\n\nただBlazeは上限設定ができないのが怖くてまだ移行してないけど。。\n\n### ユーザー認証が簡単すぎ\n\nFirebaseのAuthenticationは、めちゃくちゃよくできています。\n\nデフォルトで主要SNSログインの仕組みも用意してくれてるので、各SNS側でアプリだけ作って指示通り設定すれば、すぐにログインの仕組みができてしまいました。\n\n![f:id:o_tomomichi:20180312141940p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312141940.png \"f:id:o_tomomichi:20180312141940p:plain\")\n\nさらに最近のアップデートでパスワード不要のメールログインの仕組みが公式に実装されました。神！\n\n[Authenticate with Firebase Using Email Link in JavaScript  |  Firebase](https://firebase.google.com/docs/auth/web/email-link-auth)\n\n自前で同じ仕組みを実装してたので、早く乗り換えねば。\n\n### Functionsが便利すぎ\n\nこれはほんとに便利。\n\nうちではデータの更新を検知して、なんちゃってSSRみたいなことをして静的HTMLを出力するという処理を走らせています。\n\n![f:id:o_tomomichi:20180312142426p:plain](https://storage.googleapis.com/blog-notsobad/images/20180312142426.png \"f:id:o_tomomichi:20180312142426p:plain\")\n\nいままではHerokuのSchedulerアドオンでバッチ処理を走らせて同じことをしていました。 ただこれがFree Dynoのメモリを圧迫していて、処理が安定しなくなっていた原因でもありました。\n\nFunctionsは無料プランでも結構なキャパがあるので、頼もしいです。すごい。\n\n* * *\n\n💩 移行してみてのつらみ\n-------------\n\n一方でFirebaseに移行して感じているつらみと不安。\n\n### カジュアルに障害が起きる\n\nベータのサービスが多いせいもありますが、よく落ちます。\n\n自分が使っている範囲だと特にHostingとFunctionsがやばい。カジュアルに落ちます。\n\nインフラ側で落ちちゃうとどうしようもなくて結構困ってしまうのですが、DB（Firestore）が無事でHostingが落ちてるだけなら、最悪Storageにでも置きなおしてドメイン振ればいけるはず。\n\n一方でFirestoreが落ちると、けっこうどうしようもないですね。どうしよう。 今のところFirestoreはほぼ障害ないのが救いですが。。（レスポンスがめっちゃ遅くなるときはある）\n\n### 管理画面が貧弱\n\nサービスを運営していると、データをちょっと修正したいときとかあるじゃないですか。 Firebaseの公式管理画面（コンソール）だと、これがものすごく大変です。 データの一覧性もないし、検索性はほぼないし、クエリ投げたりもできないし。。\n\n### データバックアップができない\n\nできません。どうしたらいいんですか（切実）。\n\nRealtimeDatabaseは有料プランならバックアップオプションが用意されてたんですが、Firestoreは有料版でもそもそも存在しない。。 一応npmモジュールでバックアップ取れるやつがあるので触ってみてますが、もうちょっと公式でサポートしてほしい。\n\n### 初回表示が遅くなった\n\nこれはfirebaseの問題ではなく、SPA化したことの弊害ですね。 何も考えずにSPA化すると、最初の読み込みが重くなりがち。一回読み込めば中の遷移はさくさくなんですけどね。\n\nキャッシュがない状態でもユーザービリティを損なうほど遅いわけじゃないので、いったん後回しにしてます。 ただPageSpeedInsightとか Lighthouseとかでauditしてみると、めっちゃ怒られる。。\n\nトップページから入ってきて中に進むユーザーが多いので、将来的にはトップページを静的にしてAMP化、後続のアプリ部分をPWA化しておいて、AMPアクセス時にpreloadするような仕組み（PWAMP！）にすれば爆速化できるんじゃないかと思ってます。が、PWAこわくてまだ手を出せてない。\n\n[www.ampproject.org](https://www.ampproject.org/docs/integration/pwa-amp#amp-as-entry-point-into-your-pwa)\n\nMobileFirstIndexも始まったし、そろそろやらねばですね。がんばる。。\n\n### SEOも弱くなった\n\nこれもFirebaseは関係なく、よく言われるSPA化の弊害に見事にはまってしまいました。\n\n*   Googleにインデックスされず、SEOに弱くなった\n*   SNSシェア時にOGPが反映されない\n\nどちらもbotがアクセスしてきたときに、動的に変更してるmetaタグを読めず、エンドポイントのindex.htmlに書いてあるデフォルトのmetaタグを読んじゃってることが原因です。\n\nこれについては、特にSEO/OGPが必要になるコンテンツページに絞って、Functionsで動的にmetaタグを書き換えて配信することで一応対応できました。\n\nまたbotがページ内のリンクたどれてるかもあやしいので、sitemapとRSSフィードを配信してクロールしやすくもしています。\n\nこの辺の詳細はまた別で整理してみようかと。\n\n（2018年4月3日追記）\n\n[blog.notsobad.jp](http://blog.notsobad.jp/entry/2018/04/03/235004)\n\n書きました。\n\n* * *\n\nまとめ\n---\n\nなぜかうれしみよりつらみの方が多くなってしまった。なぜだ。。 しかし実際にリニューアルは不可避でしたし、いまのところ非常にうまく機能してると思います。\n\nまたぼくが解決策を知らないだけの可能性もあるので、もしお気づきのところあれば指摘もらえるとうれしいです。 ベータ版を抜ければ解決しそうな問題も多いので、早く公式で色々対応してくれるといいですね。\n\n信じてもらえないかもしれないけど、Firebaseは本当におすすめですよ。 みんな早くおいで！\n\nおしまい。","date":1522470307000,"image":"https://storage.googleapis.com/blog-notsobad/images/20180312145525.png","tag":["技術系","THE TOURNAMENT","Firebase","Heroku","Riot.js"]}}]},"tag":"Riot.js","page":1,"hasNextPage":false},"__N_SSG":true}