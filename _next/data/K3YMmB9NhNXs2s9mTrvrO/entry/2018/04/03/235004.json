{"pageProps":{"entry":{"title":"Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話","slug":"2018/04/03/235004","excerpt":"FJUG#3でLTさせてもらってきました！\n\n<iframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Ffirebase-community.connpass.com%2Fevent%2F80526%2F\" title=\"Firebase Japan User Group / meetup / 3 (2018/04/02 19:00〜)\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"></iframe><cite class=\"hatena-citation\"><a href=\"https://firebase-community.connpass.com/event/80526/\">firebase-community.connpass.com</a></cite>\n\n前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。\n\n発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。","content":"FJUG#3でLTさせてもらってきました！\n\n<iframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Ffirebase-community.connpass.com%2Fevent%2F80526%2F\" title=\"Firebase Japan User Group / meetup / 3 (2018/04/02 19:00〜)\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"></iframe><cite class=\"hatena-citation\"><a href=\"https://firebase-community.connpass.com/event/80526/\">firebase-community.connpass.com</a></cite>\n\n前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。\n\n発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。* * *\n\nLT内容\n----\n\n[https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban](https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban)\n\n3行で要約\n-----\n\n*   Riot.js/Firebaseでサービスをリニューアルしたら、Googleにインデックスされなくなって困りました\n*   SSRとか大変なのは避けたかったので、Functionsでmetaタグだけ差し替えたんだけどいいですよね？\n*   それだけだとクロールされないので、Functionsで超お手軽にRSSフィードとsitemapを配信する方法も試してみましたよ。\n\n一言でいうと、Functions最高ー。\n\n背景的な話\n-----\n\nこのコンテンツは、こちらの記事の追記のような位置付けです。\n\n<iframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.notsobad.jp%2Fentry%2F2018%2F03%2F31%2F132507\" title=\"3年間運用してきたWebサービスを「Rails x Heroku」から「Riot.js x Firebase」に移行した話 - NOT SO BADなブログ\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"></iframe><cite class=\"hatena-citation\"><a href=\"http://blog.notsobad.jp/entry/2018/03/31/132507\">blog.notsobad.jp</a></cite>\n\nサイトリニューアルで出てきたSEO問題を、できるだけ楽して解決できないかとがんばった記録になっております。\n\nエクスキューズ\n-------\n\nこれでいいんじゃないですかとか適当なこと言ってますが、会社でこんなことしてたら怒られるかもしれないので気をつけてください。\n\n> 「SSRまではいらないけど、ある程度metaを動的にコントロールしたい」っていう欲求は結構理解できる。特に趣味プロでバックにfirebase 、みたいなシチュと割と相性良さそうなイメージだ [#fjug](https://twitter.com/hashtag/fjug?src=hash&ref_src=twsrc%5Etfw)\n> \n> — Yosuke Kurami (@Quramy) [2018年4月2日](https://twitter.com/Quramy/status/980772868182065152?ref_src=twsrc%5Etfw)\n\n温度感としては、@Quramyさんが書いてくださってるのがほんとにその通りって感じじゃないかと。\n\nスライドにも書いてますが、とはいえGoogleBotにちゃんと認識されてるならそもそもこんなことしたくなかったわけで。。\n\nあくまでインデックスされなくて困ってて、でもSSRまでしたくなくて、っていうひとつの事例としてお楽しみください。 （パフォーマンス改善のためにSSR、とかって文脈ではない）\n\n同じようなシチュエーションの人の助けになればうれしいです。\n\n* * *\n\n以下、やったこと３つをそれぞれ少しだけ追加説明していきます。\n\n① Functionsでmetaタグだけレンダリング\n--------------------------\n\n要するに、SPAでエンドポイントになるindex.htmlをそのまま返すんじゃなくて、functionsをかませてmetaタグだけ書き換えてから返すという、SMR（Serverside Metatag Rendering）です。聞いたことないけど。\n\nけっこう探しても事例がなくて不安だったんですが、Lambdaでやってるという話を聞くと安心感があります。\n\n> 同じようなコンテキストでAWS Lambdaで動的にmetaレンダリングしてます、みたいな話を以前に聞いたことあるし、function 利用してmetaもそんなに悪手では無い気と思ってる [#fjug](https://twitter.com/hashtag/fjug?src=hash&ref_src=twsrc%5Etfw)\n> \n> — Yosuke Kurami (@Quramy) [2018年4月2日](https://twitter.com/Quramy/status/980772075513176064?ref_src=twsrc%5Etfw)\n\n全体的に@Quramyさんのコメントに救われてる。。\n\nこのやり方で懸念になるのはFunctionsの使用量とパフォーマンスなわけですが、FunctionsのレスポンスはCDNにキャッシュできるというのが、意外と知られていなかったりしますよね（ぼくが知らなかっただけですがw）\n\n[Cloud Functions による動的コンテンツの配信  |  Firebase](https://firebase.google.com/docs/hosting/functions?hl=ja#managing_cache_behavior)\n\nCDNから返してくれればFunctionsはトリガーされずに済むので、アクセスが増えてもそこまで使用量は増えない、はず。\n\nとはいえまだ実運用で大量のアクセスさばいて大丈夫でした、という経験があるわけではないので、ご利用は自己責任でお願いします。 blazeプランは料金上限を設定できないって、結構こわいですね。\n\n* * *\n\n② Functionsでお手軽RSSフィード配信\n------------------------\n\nmetaタグレンダリングでbotに認識されるようになりましたが、クロールしてもらえないと意味がありません。 というわけでRSSフィードとsitemapを極小労力で用意してみます。\n\nまずはRSSフィードですが、これもFunctionsを使って、/feedにアクセスが来たらfirestoreから最新のデータを取ってXMLで返すようにしました。\n\n簡単すぎて、node-rssが便利だったことくらいしか特に言うことがない。。\n\nしかし猛烈にお手軽なので、とりあえずやっといて損はないんじゃないでしょうか。 これこそ更新は1日数回でいいと思うので、長めにキャッシュして節約したいところです。\n\n* * *\n\n③ スプレッドシートでお手軽sitemap配信\n-----------------------\n\n最後にsitemapの作成。たぶん過去最高に頭わるそうなsitemapのハックです。\n\n![f:id:o_tomomichi:20180403184508p:plain](https://storage.googleapis.com/blog-notsobad/images/20180403184508.png \"f:id:o_tomomichi:20180403184508p:plain\")\n\nということは、スプレッドシートにURL一覧作ってCSV形式で公開すると、それがvalidなsitemapのURLになってしまうと。\n\nさらに更新は、さっきのRSSのフィード更新をトリガーに、IFTTTでシートに自動追記。 ついにコードを1行も書くことすらなく、自動更新されるsitemapをお手軽に作ることができました。\n\nsitemapの管理って地味にめんどくさいので、ミニマムでやるなら意外とおすすめです。 機会があればぜひ試してみてください。\n\n* * *\n\nまとめ\n---\n\nという感じでLTをしてきたのですが、調べて実装終えたのが発表ぎりぎりだったので、結果の検証までできてませんでした。\n\n実装から数日経ってどうなったかというと、、\n\n![f:id:o_tomomichi:20180403185752p:plain](https://storage.googleapis.com/blog-notsobad/images/20180403185752.png \"f:id:o_tomomichi:20180403185752p:plain\")\n\n![f:id:o_tomomichi:20180403185803p:plain](https://storage.googleapis.com/blog-notsobad/images/20180403185803.png \"f:id:o_tomomichi:20180403185803p:plain\")\n\nいい感じ。\n\nもちろんfunctionsも無料枠で収まるペースです。よかったよかった。","date":1522767004000,"image":"https://storage.googleapis.com/blog-notsobad/images/20180403035841.png","tag":["技術系","Firebase","THE TOURNAMENT","Riot.js"]}},"__N_SSG":true}